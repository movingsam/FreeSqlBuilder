@using FreeSqlBuilder.TemplateEngine.Utilities
@using CurdTask = FreeSqlBuilder.TemplateEngine.CurdTask
@model CurdTask
@{
    var task = Model;
    var project = task.Task.Project;
    var table = task.CurrentTable;
    var nick = table?.CsName?.ToLower();
    var repName = $"_{nick}Rep";
    var includes = new List<string>();    
    var navigates = table.ColumnsByCs.Where(x => table.GetTableRef(x.Value.CsName, false) != null).Select(x=>table.GetTableRef(x.Value.CsName,false)).ToList();
    if (navigates.Where(x=>x.RefType == FreeSql.Internal.Model.TableRefType.OneToOne)?.Count() > 0) {
        includes.AddRange(navigates.Where(x=>x.RefType == FreeSql.Internal.Model.TableRefType.OneToOne).Select(s=>$"Include({nick}=>{nick}.{s.Property.Name})"));
    }
    var includeStr = string.Join(Html.NewLine(Html.PadLeft(8)+"."),includes);
    includeStr = (!string.IsNullOrWhiteSpace(includeStr) ? "." : "") + includeStr;
    var includeManys = new List<string>();
    if (navigates.Where(x=>x.RefType == FreeSql.Internal.Model.TableRefType.ManyToOne)?.Count() > 0) {
        includeManys.AddRange(navigates.Where(x=>x.RefType == FreeSql.Internal.Model.TableRefType.ManyToOne).Select(s=>$"IncludeMany({nick}=>{nick}.{s.Property.Name})"));
    }
    var includeManysStr = string.Join(Html.NewLine(Html.PadLeft(8)+"."),includeManys);
    includeManysStr = (!string.IsNullOrWhiteSpace(includeManysStr) ? Html.NewLine(Html.PadLeft(8)+".") : "") + includeManysStr;
}
@(Html.NewLine($"#region {table?.Comment}相关增删改查"))
@Html.PadLeft(4)@($"{table?.Comment}分页查询".GetCSharpSummary())
@Html.PadLeft(4)public async Task<@(project.GetPageViewDto(table.CsName))>Query@(table.CsName)Page (@project.GetPagedDto(table.CsName) dto){
@($@"
    var param = dto as IPaged;
    var res = await {repName}.Select{includeStr}{includeManysStr}
                             .Page(ref param)
                             .ToListAsync();")
        var datas = Mapper.Map<@($"List<{project.GetDto(table.CsName)}>")>(res);
        return new @(project.GetPageViewDto(table.CsName))(param, datas);
}
@Html.PadLeft(4)@($"{table.Comment}新增".GetCSharpSummary())
@Html.PadLeft(4)public async Task<@("bool")>Add@(table.CsName) (@project.GetPostDataDto(table.CsName) dto){
@($@"
     await {repName}.InsertAsync(Mapper.Map<{table.CsName}>(dto));")
     await UowManager.CommitAsync();
     return true;
}
@Html.PadLeft(4)@($"{table.Comment}修改".GetCSharpSummary())
@Html.PadLeft(4)public async Task<@("bool")>Update@(table.CsName) (@project.GetPostDataDto(table.CsName) dto){
     @($"await {repName}.UpdateAsync(Mapper.Map<{table.CsName}>(dto));")
     await UowManager.CommitAsync();
     return true;
}
@Html.PadLeft(4)@($"{table.Comment}删除".GetCSharpSummary())
@Html.PadLeft(4)public async Task<@("bool")> Delete@(table.CsName)(List<@table.GetPrimarysName()> ids){
@($@"
      await {repName}.DeleteAsync(x=>ids.Contains(x.Id));")
      await UowManager.CommitAsync();
      return true;
}
@Html.PadLeft(4)@($"{table.Comment}查询".GetCSharpSummary())
@Html.PadLeft(4)public async Task<@project.GetDto(table.CsName)> Get@(table.CsName) (@table.GetPrimarysName() id){
@($@"
      var res = await {repName}.Select{includeStr}{includeManysStr}.Where(x=>x.Id == id).ToOneAsync();")
      return Mapper.Map<@($"{project.GetDto(table.CsName)}")>(res);
}
@(Html.NewLine("#endregion"))
@(Html.NewLine())